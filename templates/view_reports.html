{% extends "base.html" %}

{% block content %}
<div class="content">
    <h2>View Reports</h2>
    
    <div class="report-filters">
        <form method="GET" class="filter-form">
            {% if user.role == 'admin' %}
            <div class="form-group">
                <label>Facility</label>
                <select name="facility_id" class="form-control">
                    <option value="">All Facilities</option>
                    {% for facility in facilities %}
                    <option value="{{ facility.id }}" {% if selected_facility == facility.id %}selected{% endif %}>
                        {{ facility.name }} ({{ facility.district }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label>Period</label>
                <select name="period" class="form-control">
                    <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="quarterly" {% if period == 'quarterly' %}selected{% endif %}>Quarterly</option>
                    <option value="">All Periods</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>From Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            
            <div class="form-group">
                <label>To Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{{ url_for('view_reports') }}" class="btn btn-secondary">Reset</a>
        </form>
    </div>
    
    {% if grouped_reports %}
        {% for period_name, reports in grouped_reports.items() %}
        <div class="report-group">
            <h3>{{ period_name }}</h3>
            
            {% for report in reports %}
            <div class="report-card">
                <div class="report-header">
                    <h4>{{ report.facility.name }} ({{ report.report_date.strftime('%Y-%m-%d') }})</h4>
                    <div class="report-actions">
                        <a href="{{ url_for('export_report', report_id=report.id, format='excel') }}" 
                           class="btn btn-sm btn-success">Excel</a>
                        <a href="{{ url_for('export_report', report_id=report.id, format='pdf') }}" 
                           class="btn btn-sm btn-danger">PDF</a>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Commodity</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Used</th>
                            <th>Closing</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in report.items %}
                        <tr>
                            <td>{{ item.commodity.name }}</td>
                            <td>{{ item.opening_balance }}</td>
                            <td>{{ item.received }}</td>
                            <td>{{ item.used }}</td>
                            <td>{{ item.closing_balance }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    {% else %}
        <p>No reports found matching your criteria.</p>
    {% endif %}
</div>
{% endblock %}
